<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Admin - Gestión de Documentos</title>
    </head>
    <body>
        <h1>Panel de Administración - TacoShare Delivery</h1>

        <div id="loginSection">
            <h2>Iniciar Sesión</h2>
            <form id="loginForm">
                <label
                    >Email:
                    <input
                        type="email"
                        id="loginEmail"
                        value="admin@tacoshare.io"
                        required /></label
                ><br /><br />
                <label
                    >Password:
                    <input type="password" id="loginPassword" required /></label
                ><br /><br />
                <button type="submit">Iniciar Sesión</button>
            </form>
            <p id="loginError"></p>
        </div>

        <div id="adminPanel" style="display: none">
            <h2>Documentos de Usuarios</h2>
            <button id="logoutBtn">Cerrar Sesión</button>
            <button id="refreshBtn">Actualizar Lista</button>
            <br /><br />

            <div id="paginationTop"></div>

            <div id="documentsContainer">
                <p>Cargando documentos...</p>
            </div>

            <div id="paginationBottom"></div>
        </div>

        <script>
            const API_BASE = window.location.origin + "/api/v1";
            let authToken = localStorage.getItem("admin_token");
            let currentPage = 1;
            let currentLimit = 20;

            // Check if already logged in
            if (authToken) {
                showAdminPanel();
                loadDocuments();
            }

            // Login form
            document
                .getElementById("loginForm")
                .addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const email = document.getElementById("loginEmail").value;
                    const password =
                        document.getElementById("loginPassword").value;

                    try {
                        const response = await fetch(`${API_BASE}/auth/login`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ email, password }),
                        });

                        const result = await response.json();

                        if (response.ok && result.status === "success") {
                            authToken = result.data.access_token;
                            localStorage.setItem("admin_token", authToken);
                            document.getElementById("loginError").textContent =
                                "";
                            showAdminPanel();
                            loadDocuments();
                        } else {
                            document.getElementById("loginError").textContent =
                                "Error: " +
                                (result.data?.error ||
                                    result.message ||
                                    "No se pudo iniciar sesión");
                        }
                    } catch (error) {
                        document.getElementById("loginError").textContent =
                            "Error de conexión: " + error.message;
                    }
                });

            // Logout
            document
                .getElementById("logoutBtn")
                .addEventListener("click", () => {
                    localStorage.removeItem("admin_token");
                    authToken = null;
                    document.getElementById("loginSection").style.display =
                        "block";
                    document.getElementById("adminPanel").style.display =
                        "none";
                });

            // Refresh documents
            document
                .getElementById("refreshBtn")
                .addEventListener("click", () => {
                    loadDocuments(currentPage, currentLimit);
                });

            function showAdminPanel() {
                document.getElementById("loginSection").style.display = "none";
                document.getElementById("adminPanel").style.display = "block";
            }

            async function loadDocuments(page = 1, limit = 20) {
                currentPage = page;
                currentLimit = limit;

                const container = document.getElementById("documentsContainer");
                container.innerHTML = "<p>Cargando documentos...</p>";

                try {
                    const response = await fetch(
                        `${API_BASE}/documents?page=${page}&limit=${limit}`,
                        {
                            headers: { Authorization: `Bearer ${authToken}` },
                        },
                    );

                    if (!response.ok) {
                        if (
                            response.status === 401 ||
                            response.status === 403
                        ) {
                            container.innerHTML =
                                "<p>No autorizado. Por favor inicia sesión nuevamente.</p>";
                            localStorage.removeItem("admin_token");
                            document.getElementById(
                                "loginSection",
                            ).style.display = "block";
                            document.getElementById(
                                "adminPanel",
                            ).style.display = "none";
                            return;
                        }
                        throw new Error("Error al cargar documentos");
                    }

                    const result = await response.json();

                    if (result.status === "success" && result.data) {
                        displayDocuments(
                            result.data.items,
                            result.data.pagination,
                        );
                    } else {
                        container.innerHTML =
                            "<p>No se pudieron cargar los documentos</p>";
                    }
                } catch (error) {
                    container.innerHTML = "<p>Error: " + error.message + "</p>";
                }
            }

            function displayPagination(pagination) {
                const paginationHTML = `
                <div class="pagination">
                    <button ${!pagination.has_previous ? "disabled" : ""} onclick="loadDocuments(1, ${pagination.per_page})">Primera</button>
                    <button ${!pagination.has_previous ? "disabled" : ""} onclick="loadDocuments(${pagination.current_page - 1}, ${pagination.per_page})">Anterior</button>
                    <span>Página ${pagination.current_page} de ${pagination.total_pages} (Total: ${pagination.total_items} documentos)</span>
                    <button ${!pagination.has_next ? "disabled" : ""} onclick="loadDocuments(${pagination.current_page + 1}, ${pagination.per_page})">Siguiente</button>
                    <button ${!pagination.has_next ? "disabled" : ""} onclick="loadDocuments(${pagination.total_pages}, ${pagination.per_page})">Última</button>
                    <label>Items por página:
                        <select onchange="loadDocuments(1, parseInt(this.value))">
                            <option value="10" ${pagination.per_page === 10 ? "selected" : ""}>10</option>
                            <option value="20" ${pagination.per_page === 20 ? "selected" : ""}>20</option>
                            <option value="50" ${pagination.per_page === 50 ? "selected" : ""}>50</option>
                            <option value="100" ${pagination.per_page === 100 ? "selected" : ""}>100</option>
                        </select>
                    </label>
                </div>
            `;

                document.getElementById("paginationTop").innerHTML =
                    paginationHTML;
                document.getElementById("paginationBottom").innerHTML =
                    paginationHTML;
            }

            function displayDocuments(documents, pagination) {
                const container = document.getElementById("documentsContainer");

                // Display pagination
                if (pagination) {
                    displayPagination(pagination);
                }

                if (!documents || documents.length === 0) {
                    container.innerHTML =
                        "<p>No hay documentos registrados</p>";
                    return;
                }

                let html =
                    '<table border="1" cellpadding="10" cellspacing="0" style="width:100%; border-collapse: collapse;">';
                html += "<thead><tr>";
                html += "<th>ID Documento</th>";
                html += "<th>ID Usuario</th>";
                html += "<th>Vehículo</th>";
                html += "<th>Placas</th>";
                html += "<th>RFC</th>";
                html += "<th>Estado Revisión</th>";
                html += "<th>Fecha Creación</th>";
                html += "<th>Acciones</th>";
                html += "<th>Documentos</th>";
                html += "</tr></thead><tbody>";

                documents.forEach((doc) => {
                    const vehicleInfo =
                        doc.vehicle_brand && doc.vehicle_model
                            ? `${doc.vehicle_brand} ${doc.vehicle_model}`
                            : "N/A";
                    const licensePlate = doc.license_plate || "N/A";
                    const rfc = doc.fiscal_rfc || "N/A";
                    const reviewed = doc.reviewed
                        ? "✅ Aprobado"
                        : "❌ Pendiente";
                    const reviewedClass = doc.reviewed ? "approved" : "pending";
                    const createdAt = new Date(doc.created_at).toLocaleString(
                        "es-MX",
                    );

                    html += "<tr>";
                    html += `<td>${doc.id.substring(0, 8)}...</td>`;
                    html += `<td>${doc.user_id.substring(0, 8)}...</td>`;
                    html += `<td>${vehicleInfo}</td>`;
                    html += `<td>${licensePlate}</td>`;
                    html += `<td>${rfc}</td>`;
                    html += `<td class="${reviewedClass}">${reviewed}</td>`;
                    html += `<td>${createdAt}</td>`;
                    html += "<td>";

                    if (!doc.reviewed) {
                        html += `<button onclick="updateDocumentStatus('${doc.id}', true)">Aprobar</button> `;
                    } else {
                        html += `<button onclick="updateDocumentStatus('${doc.id}', false)">Rechazar</button> `;
                    }

                    html += `<button onclick="viewUserDetails('${doc.user_id}')">Ver Usuario</button>`;
                    html += "</td>";

                    // Documents column
                    html +=
                        '<td><ul style="text-align: left; font-size: 12px; margin: 0; padding-left: 15px;">';
                    if (doc.ine_front_url)
                        html += `<li><a href="${doc.ine_front_url}" target="_blank">INE Frente</a></li>`;
                    if (doc.ine_back_url)
                        html += `<li><a href="${doc.ine_back_url}" target="_blank">INE Reverso</a></li>`;
                    if (doc.driver_license_front_url)
                        html += `<li><a href="${doc.driver_license_front_url}" target="_blank">Licencia Frente</a></li>`;
                    if (doc.driver_license_back_url)
                        html += `<li><a href="${doc.driver_license_back_url}" target="_blank">Licencia Reverso</a></li>`;
                    if (doc.circulation_card_url)
                        html += `<li><a href="${doc.circulation_card_url}" target="_blank">Tarjeta Circulación</a></li>`;
                    if (doc.profile_photo_url)
                        html += `<li><a href="${doc.profile_photo_url}" target="_blank">Foto Perfil</a></li>`;
                    if (doc.fiscal_certificate_url)
                        html += `<li><a href="${doc.fiscal_certificate_url}" target="_blank">Constancia Fiscal</a></li>`;
                    if (
                        !doc.ine_front_url &&
                        !doc.ine_back_url &&
                        !doc.driver_license_front_url &&
                        !doc.driver_license_back_url &&
                        !doc.circulation_card_url &&
                        !doc.profile_photo_url &&
                        !doc.fiscal_certificate_url
                    ) {
                        html += "<li>Sin documentos</li>";
                    }
                    html += "</ul></td>";

                    html += "</tr>";
                });

                html += "</tbody></table>";

                container.innerHTML = html;
            }

            async function updateDocumentStatus(documentId, reviewed) {
                const action = reviewed ? "aprobar" : "rechazar";
                if (!confirm(`¿Estás seguro de ${action} este documento?`)) {
                    return;
                }

                try {
                    const response = await fetch(
                        `${API_BASE}/documents/${documentId}`,
                        {
                            method: "PATCH",
                            headers: {
                                Authorization: `Bearer ${authToken}`,
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ reviewed }),
                        },
                    );

                    const result = await response.json();

                    if (response.ok && result.status === "success") {
                        alert(
                            `Documento ${action === "aprobar" ? "aprobado" : "rechazado"} exitosamente`,
                        );
                        loadDocuments(currentPage, currentLimit); // Reload current page
                    } else {
                        alert(
                            "Error: " +
                                (result.data?.error ||
                                    result.message ||
                                    "No se pudo actualizar"),
                        );
                    }
                } catch (error) {
                    alert("Error de conexión: " + error.message);
                }
            }

            async function viewUserDetails(userId) {
                try {
                    const response = await fetch(
                        `${API_BASE}/users/${userId}`,
                        {
                            headers: { Authorization: `Bearer ${authToken}` },
                        },
                    );

                    const result = await response.json();

                    if (response.ok && result.status === "success") {
                        const user = result.data;
                        let info = "Información del Usuario:\n\n";
                        info += `ID: ${user.id}\n`;
                        info += `Nombre: ${user.name}\n`;
                        info += `Email: ${user.email || "N/A"}\n`;
                        info += `Teléfono: ${user.phone}\n`;
                        info += `Rol: ${user.role}\n`;
                        info += `Estado: ${user.account_status || "N/A"}\n`;
                        info += `Creado: ${new Date(user.created_at).toLocaleString("es-MX")}`;
                        alert(info);
                    } else {
                        alert("Error al obtener información del usuario");
                    }
                } catch (error) {
                    alert("Error: " + error.message);
                }
            }
        </script>

        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
                max-width: 1400px;
            }
            h1 {
                color: #333;
            }
            h2 {
                color: #555;
            }
            table {
                font-size: 14px;
            }
            th {
                background-color: #f0f0f0;
                font-weight: bold;
                text-align: left;
            }
            td {
                vertical-align: top;
            }
            button {
                padding: 5px 10px;
                margin: 2px;
                cursor: pointer;
            }
            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            .approved {
                background-color: #d4edda;
                color: #155724;
                font-weight: bold;
            }
            .pending {
                background-color: #fff3cd;
                color: #856404;
                font-weight: bold;
            }
            #loginError {
                color: red;
            }
            a {
                color: #007bff;
                text-decoration: none;
            }
            a:hover {
                text-decoration: underline;
            }
            .pagination {
                margin: 15px 0;
                padding: 10px;
                background-color: #f8f9fa;
                border-radius: 5px;
                display: flex;
                align-items: center;
                gap: 10px;
                flex-wrap: wrap;
            }
            .pagination button {
                padding: 8px 12px;
            }
            .pagination span {
                font-weight: bold;
                margin: 0 10px;
            }
            .pagination select {
                padding: 5px;
            }
        </style>
    </body>
</html>
